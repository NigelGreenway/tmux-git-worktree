#!/usr/bin/env bash

CURRENT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$CURRENT_DIR/utils.sh"
source "$CURRENT_DIR/interface/bash"
source "$CURRENT_DIR/interface/fzf"

is_root_of_repo=0

### Declare vars via tmux options
ignore_list=$(get_option_value "@git-worktree-ignore-worktrees" "")
keybinding=$(get_option_value "@git-worktree-keybinding" "C-g")
modifier_key=$(get_option_value "@git-worktree-modifer" "ctrl")
delete_worktree_key=$(get_option_value "@git-worktree-delete-key" "d")
switch_to_commit_refs_key=$(get_option_value "@git-worktree-delete-key" "r")
time_to_live=$(get_option_value "@git-worktree-ttl" "2")

debug "ignore_list: $ignore_list"
debug "keybinding: $keybinding"
debug "modifer_key: $modifier_key"
debug "delete_worktree_key: $delete_worktree_key"
debug "time_to_live: $time_to_live"
### end

delete_keybinding="$modifier_key-$delete_worktree_key"
show_commit_ref_binding="$modifier_key-$switch_to_commit_refs_key"

check_condition_and_error_on_fail '[[ -z "$TMUX" ]]' 'Not running inside tmux'
check_condition_and_error_on_fail '! git rev-parse --git-dir &>/dev/null' 'Not a git repository'

if command -v fzf &> /dev/null; then
  run_fzf
else
  run_bash
fi

###
# Sanitize variables
directory=$(clean_directory "$directory")
branch=$(clean_branch_name "$branch")

if git rev-parse --is-bare-repository 2> /dev/null | grep -q "true"; then
  is_root_of_repo=1
fi

debug "Is the root of a repo: $is_root_of_repo"

if [[ "$is_root_of_repo" -eq 0 ]]; then
  directory="../$directory"
fi

debug "Worktree after bare repo check: $directory"

if [[ -d "$directory" ]]; then
  debug "Worktree '$directory' exists"
  abs_directory=$(cd "$directory" && pwd)
  debug "abs_directory: '$abs_directory'"
  window_name=$(clean_window_name $directory)
  check_condition_and_error_on_fail '! tmux new-window -c "$abs_directory" -n "$window_name"' 'Failed to create tmux window'
  exit 0
fi

debug "Worktree '$directory' doesn't exist"

if git rev-parse --quiet --verify "$branch" 2> /dev/null; then
  debug "Branch '$branch' exists"
  check_condition_and_error_on_fail '! git worktree add "$directory" "$branch"' 'Failed to create worktree'
else
  debug "Branch '$branch' doesn't exist"
  check_condition_and_error_on_fail '! git worktree add "$directory" -b "$branch" "$commit"' 'Failed to create worktree with new branch'
fi

abs_directory=$(cd "$directory" && pwd)
window_name=$(clean_window_name $directory)
debug "abs_directory: '$abs_directory'"
check_condition_and_error_on_fail '! tmux new-window -c "$abs_directory" -n "$window_name"' 'Failed to create tmux window'
